version: "3"

tasks:
  _ensure:main:
    internal: true
    silent: true
    cmds:
      - |
        BRANCH=$(git branch --show-current)
        if [ "$BRANCH" != "main" ]; then
          echo "‚ùå Error: Version bumping and tagging must be performed on the 'main' branch (current: $BRANCH)"
          exit 1
        fi
  # -----------------------------------------------------------------------------
  # Versioning

  bump:
    desc: Bump versions and generate changelog (via nx release)
    deps: [_ensure:main]
    cmds:
      - bunx nx release --yes

  # -----------------------------------------------------------------------------
  # Changelog Management

  changelog:update:
    desc: Update CHANGELOG.md from git commits
    cmds:
      - dart run scripts/update_changelog.dart

  changelog:preview:
    desc: Preview changelog updates without writing
    cmds:
      - dart run scripts/update_changelog.dart --dry-run

  # -----------------------------------------------------------------------------
  # High-level Release Builds

  web:
    desc: Build the web application for release
    cmds:
      - task: :clean
      - task: :flutter:get
      - task: :flutter:build:web

  android:
    desc: Build the Android application
    cmds:
      - task: :clean
      - task: :flutter:get
      - task: :flutter:build:android
        vars:
          BUILD_NAME: "{{.BUILD_NAME}}"
          BUILD_NUMBER: "{{.BUILD_NUMBER}}"

  ios:
    desc: Build the iOS application
    cmds:
      - task: :clean
      - task: :flutter:get
      - task: :flutter:build:ios

  linux:
    desc: Build the Linux application
    cmds:
      - task: :clean
      - task: :flutter:get
      - task: :flutter:build:linux

  windows:
    desc: Build the Windows application
    cmds:
      - task: :clean
      - task: :flutter:get
      - task: :flutter:build:windows

  macos:
    desc: Build the macOS application
    cmds:
      - task: :clean
      - task: :flutter:get
      - task: :flutter:build:macos
