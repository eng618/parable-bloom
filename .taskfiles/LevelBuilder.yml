version: "3"

tasks:
  # -----------------------------------------------------------------------------
  # Standardization Tasks for Level Builder Go Module

  validate:
    desc: Validate level-builder Go module
    dir: tools/level-builder
    cmds:
      - task: lint
      - task: test
      - task: build

  fix:
    desc: Fix level-builder Go module code (lints and formatting)
    dir: tools/level-builder
    cmds:
      - task: format
      - task: lint:fix

  # -----------------------------------------------------------------------------
  # Dependency Management

  get:
    desc: Get level-builder Go module dependencies
    run: once
    dir: tools/level-builder
    cmds:
      - go mod tidy
    preconditions:
      - sh: command -v go >/dev/null 2>&1
        msg: "Go is not installed. Please install Go to use the level-builder."

  upgrade:
    desc: Upgrade level-builder Go module dependencies
    dir: tools/level-builder
    cmds:
      - go get -u ./...
      - go mod tidy

  # -----------------------------------------------------------------------------
  # Testing

  test:
    desc: Run level-builder Go module tests
    dir: tools/level-builder
    cmds:
      - go test ./pkg/... ./cmd/... -short -coverprofile=coverage.out

  test:quick:
    desc: Run fast level-builder tests (used in validate and CI)
    dir: tools/level-builder
    cmds:
      - go test ./pkg/... ./cmd/... -short

  test:cover:
    desc: Generate HTML coverage report
    dir: tools/level-builder
    cmds:
      - go tool cover -html=coverage.out

  test:summary:
    desc: Run tests with gotestsum for better summary
    dir: tools/level-builder
    vars:
      LOCAL_BIN:
        sh: echo "$(pwd)/../../.gotmp/bin"
      GOPATH:
        sh: mkdir -p ../../.gotmp ../../.gocache && GOTMPDIR=$(pwd)/../../.gotmp GOCACHE=$(pwd)/../../.gocache go env GOPATH
    cmds:
      - mkdir -p ../../.gotmp ../../.gocache
      - PATH="{{.LOCAL_BIN}}:{{.GOPATH}}/bin:$PATH" TMPDIR=$(pwd)/../../.gotmp GOTMPDIR=$(pwd)/../../.gotmp GOCACHE=$(pwd)/../../.gocache gotestsum --format testname -- ./pkg/... ./cmd/... -short
    preconditions:
      - sh: |
          PATH="$(pwd)/../../.gotmp/bin:$(go env GOPATH)/bin:$PATH" command -v gotestsum >/dev/null 2>&1
        msg: "gotestsum is not installed. Please install it (go install gotest.tools/gotestsum@latest)"

  test:extended:
    desc: Run extended level-builder tests (heavy/resilience)
    dir: tools/level-builder
    cmds:
      - go test ./pkg/generator/strategies -run TestLIFOBacktrackingProducesDumpsAndSucceeds -v
      - go test ./pkg/generator/strategies -run TestAttemptLocalBacktrackRecovers -v
      - go test ./pkg/... ./cmd/...

  # -----------------------------------------------------------------------------
  # Linting

  lint:
    desc: Run level-builder Go module linting using golangci-lint
    dir: tools/level-builder
    cmds:
      - golangci-lint run ./pkg/... ./cmd/...
    preconditions:
      - sh: command -v golangci-lint >/dev/null 2>&1
        msg: "golangci-lint is not installed. Please install it to run Go linting."

  lint:fix:
    desc: Fix level-builder Go module linting issues (where possible)
    dir: tools/level-builder
    cmds:
      - golangci-lint run --fix ./pkg/... ./cmd/...

  # -----------------------------------------------------------------------------
  # Formatting

  format:check:
    desc: Check level-builder Go module code formatting
    dir: tools/level-builder
    cmds:
      - golangci-lint fmt --diff-colored

  format:
    desc: Format level-builder Go module code
    dir: tools/level-builder
    cmds:
      - golangci-lint fmt

  # -----------------------------------------------------------------------------
  # Build

  build:
    desc: Build the level-builder Go module
    dir: tools/level-builder
    sources:
      - "**/*.go"
      - "go.mod"
      - "go.sum"
    generates:
      - level-builder
    cmds:
      - go build -o level-builder .
    preconditions:
      - sh: command -v go >/dev/null 2>&1
        msg: "Go is not installed."
