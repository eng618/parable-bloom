version: "3"

tasks:
  # -----------------------------------------------------------------------------
  # Account Management

  login:
    desc: Log in to Firebase
    cmds:
      - firebase login
    preconditions:
      - sh: command -v firebase >/dev/null 2>&1
        msg: "Firebase CLI is not installed."

  # -----------------------------------------------------------------------------
  # Local Emulators

  emulators:start:
    desc: Start Firebase emulators
    dir: apps/parable-bloom
    cmds:
      - firebase emulators:start
    preconditions:
      - sh: command -v firebase >/dev/null 2>&1
        msg: "Firebase CLI is not installed."

  emulators:exec:
    desc: Execute a command with Firebase emulators running (arguments validated via wrapper)
    vars:
      CLI_ARGS: ""
    cmds:
      - ./scripts/firebase/emulators_exec.sh "{{.CLI_ARGS}}"
    preconditions:
      - sh: command -v firebase >/dev/null 2>&1
        msg: "Firebase CLI is not installed."

  # -----------------------------------------------------------------------------
  # Deployment

  functions:deploy:
    desc: Deploy Firebase functions
    dir: apps/parable-bloom
    cmds:
      - firebase deploy --only functions
    preconditions:
      - sh: command -v firebase >/dev/null 2>&1
        msg: "Firebase CLI is not installed."

  firestore:rules:deploy:
    desc: Deploy Firestore security rules
    dir: apps/parable-bloom
    cmds:
      - firebase deploy --only firestore:rules
    preconditions:
      - sh: command -v firebase >/dev/null 2>&1
        msg: "Firebase CLI is not installed."

  storage:rules:deploy:
    desc: Deploy Cloud Storage security rules
    dir: apps/parable-bloom
    cmds:
      - firebase deploy --only storage:rules
    preconditions:
      - sh: command -v firebase >/dev/null 2>&1
        msg: "Firebase CLI is not installed."

  hosting:deploy:
    desc: Deploy Firebase Hosting
    dir: apps/parable-bloom
    cmds:
      - firebase deploy --only hosting
    preconditions:
      - sh: command -v firebase >/dev/null 2>&1
        msg: "Firebase CLI is not installed."

  deploy:all:
    desc: Deploy all Firebase services
    dir: apps/parable-bloom
    cmds:
      - firebase deploy
    preconditions:
      - sh: command -v firebase >/dev/null 2>&1
        msg: "Firebase CLI is not installed."

  # Hosting Specific (using secrets or preview channels)
  h:deploy:
    desc: Deploy to Firebase Hosting
    dir: apps/parable-bloom
    preconditions:
      - sh: command -v firebase >/dev/null 2>&1
        msg: "Firebase CLI is not installed."
    cmds:
      - firebase deploy --only hosting

  hosting:channel:deploy:
    desc: Deploy to a Firebase Hosting channel
    dir: apps/parable-bloom
    vars:
      CHANNEL: '{{.CHANNEL | default "preview"}}'
    cmds:
      - firebase hosting:channel:deploy "{{.CHANNEL}}" --project parable-bloom {{.CLI_ARGS}}
    preconditions:
      - sh: command -v firebase >/dev/null 2>&1
        msg: "Firebase CLI is not installed."

  # -----------------------------------------------------------------------------
  # FlutterFire Configuration

  generate-dummy-options:
    desc: Generate a dummy firebase_options.dart for local development/testing
    cmds:
      - dart scripts/generate_dummy_firebase_options.dart

  configure:
    desc: Configure Firebase using FlutterFire CLI for local development
    dir: apps/parable-bloom
    cmds:
      - flutterfire configure --project=parable-bloom --platforms=android,ios,web,linux,macos,windows --yes
    preconditions:
      - sh: command -v flutterfire >/dev/null 2>&1
        msg: "FlutterFire CLI is not installed."

  configure:android:
    desc: Configure Firebase for Android only
    dir: apps/parable-bloom
    cmds:
      - flutterfire configure --project=parable-bloom --platforms=android --yes
    preconditions:
      - sh: command -v flutterfire >/dev/null 2>&1
        msg: "FlutterFire CLI is not installed."

  configure:ios:
    desc: Configure Firebase for iOS only
    dir: apps/parable-bloom
    cmds:
      - flutterfire configure --project=parable-bloom --platforms=ios --yes
    preconditions:
      - sh: command -v flutterfire >/dev/null 2>&1
        msg: "FlutterFire CLI is not installed."

  configure:web:
    desc: Configure Firebase for Web only
    dir: apps/parable-bloom
    cmds:
      - flutterfire configure --project=parable-bloom --platforms=web --yes
    preconditions:
      - sh: command -v flutterfire >/dev/null 2>&1
        msg: "FlutterFire CLI is not installed."

  configure:linux:
    desc: Configure Firebase for Linux only
    dir: apps/parable-bloom
    cmds:
      - flutterfire configure --project=parable-bloom --platforms=linux --yes
    preconditions:
      - sh: command -v flutterfire >/dev/null 2>&1
        msg: "FlutterFire CLI is not installed."

  configure:macos:
    desc: Configure Firebase for macOS only
    dir: apps/parable-bloom
    cmds:
      - flutterfire configure --project=parable-bloom --platforms=macos --yes
    preconditions:
      - sh: command -v flutterfire >/dev/null 2>&1
        msg: "FlutterFire CLI is not installed."

  configure:windows:
    desc: Configure Firebase for Windows only
    dir: apps/parable-bloom
    cmds:
      - flutterfire configure --project=parable-bloom --platforms=windows --yes
    preconditions:
      - sh: command -v flutterfire >/dev/null 2>&1
        msg: "FlutterFire CLI is not installed."

  # -----------------------------------------------------------------------------
  # CI Configuration

  configure:ci:web:
    desc: Configure Firebase for Web in CI
    dir: apps/parable-bloom
    cmds:
      - task: configure:ci
        vars: {PLATFORMS: "web"}

  configure:ci:
    desc: Configure Firebase for multiple platforms in CI
    dir: apps/parable-bloom
    vars:
      PLATFORMS: '{{.PLATFORMS | default "android,ios,macos,web,windows"}}'
    cmds:
      - |
        flutterfire configure \
          --project=parable-bloom \
          --platforms={{.PLATFORMS}} \
          --yes \
          --out=lib/firebase_options.dart
    preconditions:
      - sh: command -v flutterfire >/dev/null 2>&1
        msg: "FlutterFire CLI is not installed."
