version: '3'

tasks:
  build:web:
    desc: Build the Flutter application for Web
    sources:
      - lib/**/*
      - assets/**/*
      - pubspec.yaml
      - web/**/*
    generates:
      - build/web/**/*
    cmds:
      - flutter build web --release
    preconditions:
      - sh: command -v flutter >/dev/null 2>&1
        msg: "Flutter is not installed."

  build:android:
    desc: Build the Android application
    cmds:
      - |
        flutter build appbundle --release \
          {{if .BUILD_NAME}}--build-name "{{.BUILD_NAME}}"{{end}} \
          {{if .BUILD_NUMBER}}--build-number "{{.BUILD_NUMBER}}"{{end}}

  build:ios:
    desc: Build the iOS application
    platforms: [darwin]
    cmds:
      - flutter build ios --release

  build:linux:
    desc: Build the Linux application
    platforms: [linux]
    cmds:
      - flutter build linux --release

  build:windows:
    desc: Build the Windows application
    platforms: [windows]
    cmds:
      - flutter build windows --release

  build:macos:
    desc: Build the macOS application
    platforms: [darwin]
    cmds:
      - flutter build macos --release

  serve:web:
    desc: Serve the application locally
    cmds:
      - flutter run -d chrome

  serve:web:clean:
    desc: Clean and serve the application
    cmds:
      - task: clean
      - task: get
      - task: serve:web

  dev:
    desc: Run the application in dev mode with Chromium
    platforms: [linux]
    cmds:
      - CHROME_EXECUTABLE=/snap/bin/chromium flutter run -d chrome

  dev:
    desc: Run the application in dev mode with Chrome
    platforms: [darwin]
    cmds:
      - flutter run -d chrome

  serve:linux:
    desc: Serve the application on Linux
    platforms: [linux]
    cmds:
      - flutter run -d linux

  serve:windows:
    desc: Serve the application on Windows
    platforms: [windows]
    cmds:
      - flutter run -d windows

  serve:macos:
    desc: Serve the application on macOS
    platforms: [darwin]
    cmds:
      - flutter run -d macos

  serve:android:
    desc: Serve the application on Android
    cmds:
      - flutter run -d 'SM S901U'

  serve:ios:
    desc: Serve the application on iOS simulator (auto-selects available simulator)
    platforms: [darwin]
    cmds:
      - task: get
      - cd ios && pod install
      - |
        # Auto-select iOS simulator - find booted simulator or boot the first available one
        BOOTED_SIM=$(xcrun simctl list devices booted | grep -E "iPhone|iPad" | head -1 | awk -F'[()]' '{print $2}')
        if [ -z "$BOOTED_SIM" ]; then
          # No booted simulator, find and boot the first available iPhone simulator
          SIM_ID=$(xcrun simctl list devices available | grep -E "iPhone" | head -1 | awk -F'[()]' '{print $2}')
          if [ -n "$SIM_ID" ]; then
            echo "Booting iOS simulator: $SIM_ID"
            xcrun simctl boot "$SIM_ID" 2>/dev/null || true
            sleep 2
          fi
        fi
      - flutter run

  serve:ios:clean:
    desc: Clean and serve the application on iOS simulator
    platforms: [darwin]
    cmds:
      - task: clean
      - task: get
      - cd ios && pod install
      - |
        # Auto-select iOS simulator - find booted simulator or boot the first available one
        BOOTED_SIM=$(xcrun simctl list devices booted | grep -E "iPhone|iPad" | head -1 | awk -F'[()]' '{print $2}')
        if [ -z "$BOOTED_SIM" ]; then
          # No booted simulator, find and boot the first available iPhone simulator
          SIM_ID=$(xcrun simctl list devices available | grep -E "iPhone" | head -1 | awk -F'[()]' '{print $2}')
          if [ -n "$SIM_ID" ]; then
            echo "Booting iOS simulator: $SIM_ID"
            xcrun simctl boot "$SIM_ID" 2>/dev/null || true
            sleep 2
          fi
        fi
      - flutter run

  # Environment-Specific Tasks
  serve:dev:
    desc: Run the application in development environment
    cmds:
      - flutter run --dart-define=APP_ENV=dev

  serve:dev:web:
    desc: Run the web application in development environment
    cmds:
      - flutter run -d chrome --dart-define=APP_ENV=dev

  serve:preview:
    desc: Run the application in preview environment
    cmds:
      - flutter run --dart-define=APP_ENV=preview

  serve:preview:web:
    desc: Run the web application in preview environment
    cmds:
      - flutter run -d chrome --dart-define=APP_ENV=preview

  serve:prod:
    desc: Run the application in production environment
    cmds:
      - flutter run --dart-define=APP_ENV=prod

  serve:prod:web:
    desc: Run the web application in production environment
    cmds:
      - flutter run -d chrome --dart-define=APP_ENV=prod

  build:web:dev:
    desc: Build the web application for development environment
    cmds:
      - flutter build web --release --dart-define=APP_ENV=dev

  build:web:preview:
    desc: Build the web application for preview environment
    cmds:
      - flutter build web --release --dart-define=APP_ENV=preview

  build:web:prod:
    desc: Build the web application for production environment
    cmds:
      - flutter build web --release --dart-define=APP_ENV=prod

  test:dev:
    desc: Run tests in development environment
    cmds:
      - flutter test --dart-define=APP_ENV=dev

  test:preview:
    desc: Run tests in preview environment
    cmds:
      - flutter test --dart-define=APP_ENV=preview

  test:prod:
    desc: Run tests in production environment
    cmds:
      - flutter test --dart-define=APP_ENV=prod

  analyze:
    desc: Analyze the Flutter code
    cmds:
      - flutter analyze

  test:
    desc: Run Flutter tests (excludes level solver tests)
    cmds:
      - flutter test --exclude-tags=level-solver

  test:levels:
    desc: Run level solver tests only (for when adding new levels)
    cmds:
      - flutter test test/level_validation_test.dart

  test:all:
    desc: Run all tests including level solver tests
    cmds:
      - flutter test

  format:
    desc: Format the Flutter code
    cmds:
      - dart format .

  format:check:
    desc: Check if Flutter code is formatted
    cmds:
      - find lib test -name "*.dart" -not -name "firebase_options.dart" -exec dart format --output=none --set-exit-if-changed {} \;

  lint:
    desc: Run Flutter linting
    cmds:
      - flutter analyze --no-fatal-infos --no-fatal-warnings

  lint:fix:
    desc: Fix Flutter linting issues
    cmds:
      - dart fix --apply

  generate_icons:
    desc: Generate app icons and favicon for all platforms using flutter_launcher_icons
    cmds:
      - dart run flutter_launcher_icons

  update_icons:
    desc: Update app icons using flutter_launcher_icons
    cmds:
      - flutter pub run flutter_launcher_icons:main

  get:
    desc: Get Flutter dependencies
    run: once
    cmds:
      - flutter pub get
    preconditions:
      - sh: command -v flutter >/dev/null 2>&1
        msg: "Flutter is not installed. Please install Flutter to proceed."

  upgrade:
    desc: Upgrade Flutter dependencies
    cmds:
      - flutter pub upgrade

  clean:
    desc: Clean the Flutter build cache
    cmds:
      - flutter clean
