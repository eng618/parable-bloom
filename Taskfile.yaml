version: '3'

tasks:
  # -----------------------------------------------------------------------------
  # Flutter Builds

  build:web:
    desc: Build the Flutter application
    cmds:
      - flutter build web --release

  build:android:
    desc: Build the Android application
    cmds:
      - |
        flutter build appbundle --release \
          {{if .BUILD_NAME}}--build-name "{{.BUILD_NAME}}"{{end}} \
          {{if .BUILD_NUMBER}}--build-number "{{.BUILD_NUMBER}}"{{end}}

  build:ios:
    desc: Build the iOS application
    cmds:
      - flutter build ios --release

  build:linux:
    desc: Build the Linux application
    cmds:
      - flutter build linux --release

  build:windows:
    desc: Build the Windows application
    cmds:
      - flutter build windows --release

  build:macos:
    desc: Build the macOS application
    cmds:
      - flutter build macos --release

  # -----------------------------------------------------------------------------
  # Release Builds

  release:web:
    desc: Build the web application for release
    cmds:
      - task: clean
      - task: get
      - task: build:web

  release:android:
    desc: Build the Android application
    cmds:
      - task: clean
      - task: get
      - task: build:android

  release:ios:
    desc: Build the iOS application
    cmds:
      - task: clean
      - task: get
      - task: build:ios

  release:linux:
    desc: Build the Linux application
    cmds:
      - task: clean
      - task: get
      - task: build:linux

  release:windows:
    desc: Build the Windows application
    cmds:
      - task: clean
      - task: get
      - task: build:windows

  release:macos:
    desc: Build the macOS application
    cmds:
      - task: clean
      - task: get
      - task: build:macos

  # -----------------------------------------------------------------------------
  # Level Management

  levels:generate:
    desc: Generate new levels using the Go tool (usage - task levels:generate COUNT=50)
    dir: tools/level-builder
    cmds:
      - go run . generate --count {{.COUNT | default 50}}

  levels:validate:
    desc: Validate existing levels and modules using the Go tool
    dir: tools/level-builder
    cmds:
      - go run . validate

  levels:validate-solvable:
    desc: Validate existing levels and run solvability checks (may be slow)
    dir: tools/level-builder
    cmds:
      - go run . validate --check-solvable --max-states {{.MAX_STATES | default 100000}}

  tutorials:validate:
    desc: Validate tutorial lessons using the Go tool
    dir: tools/level-builder
    cmds:
      - go run . validate-tutorials

  tutorials:validate-solvable:
    desc: Validate tutorial lessons and run solvability checks (may be slow)
    dir: tools/level-builder
    cmds:
      - go run . validate-tutorials --check-solvable --max-states {{.MAX_STATES | default 100000}}

  levels:validate-experiments:
    desc: Run solvability experiments comparing BFS and A* (outputs bfs/astar stats)
    dir: tools/level-builder
    cmds:
      - go run . validate --check-solvable --max-states {{.MAX_STATES | default 200000}} --use-astar=false
      - mv validation_stats.json validation_stats_bfs.json || true
      - go run . validate --check-solvable --max-states {{.MAX_STATES | default 200000}} --use-astar=true --astar-weight {{.ASTAR_WEIGHT | default 10}}
      - mv validation_stats.json validation_stats_astar.json || true
      - echo "Created validation_stats_bfs.json and validation_stats_astar.json"

  levels:validate-astar-experiments:
    desc: Run solvability experiments using A* vs BFS
    dir: tools/level-builder
    cmds:
      - go run . validate --check-solvable --max-states {{.MAX_STATES | default 200000}} --use-astar=false
      - mv validation_stats.json validation_stats_bfs.json || true
      - go run . validate --check-solvable --max-states {{.MAX_STATES | default 200000}} --use-astar=true --astar-weight {{.ASTAR_WEIGHT | default 10}}
      - mv validation_stats.json validation_stats_astar.json || true
      - go run . validate --check-solvable --max-states {{.MAX_STATES | default 200000}} --use-astar=true --astar-weight {{.ASTAR_WEIGHT | default 10}}
      - echo "Created validation_stats_bfs.json and validation_stats_astar.json"

  levels:astar-weight-sweep:
    desc: Sweep A* weight parameter and collect stats (weights comma-separated, default 5,10,20)
    dir: tools/level-builder
    cmds:
      - |
        WEIGHTS="${WEIGHTS:-5,10,20}"
        OLD_IFS="$IFS"
        IFS=','
        for w in $WEIGHTS; do
          # Validate that 'w' is a positive integer to avoid command injection
          case "$w" in
            ''|*[!0-9]*)
              echo "Invalid weight: $w" >&2
              exit 1
              ;;
          esac
          echo "Running A* with weight=$w"
          go run . validate --check-solvable --max-states {{.MAX_STATES | default 200000}} --use-astar=true --astar-weight "$w"
          mv validation_stats.json validation_stats_astar_w${w}.json || true
        done
        IFS="$OLD_IFS"
      - echo "Created validation_stats_astar_w*.json"

  # -----------------------------------------------------------------------------
  # Version Management

  version:bump:patch:
    desc: Bump patch version and tag (1.0.0 → 1.0.1)
    cmds:
      - dart run scripts/bump_version.dart --patch

  version:bump:minor:
    desc: Bump minor version and tag (1.0.0 → 1.1.0)
    cmds:
      - dart run scripts/bump_version.dart --minor

  version:bump:major:
    desc: Bump major version and tag (1.0.0 → 2.0.0)
    cmds:
      - dart run scripts/bump_version.dart --major

  version:bump:build:
    desc: Bump build number and tag (tag includes build) (1.0.0+1 → 1.0.0+2)
    cmds:
      - dart run scripts/bump_version.dart --build

  version:set:
    desc: Set specific version (usage - task version:set VERSION=2.0.0+5)
    cmds:
      - dart run scripts/bump_version.dart --set {{.VERSION}}

  changelog:update:
    desc: Update CHANGELOG.md from git commits
    cmds:
      - dart run scripts/update_changelog.dart

  changelog:preview:
    desc: Preview changelog updates without writing
    cmds:
      - dart run scripts/update_changelog.dart --dry-run

  # -----------------------------------------------------------------------------
  # Fastlane - Android

  fastlane:android:deploy:
    desc: Deploy Android to Google Play (Internal Testing) via Fastlane
    dir: android
    cmds:
      - fastlane deploy

  fastlane:android:beta:
    desc: Deploy Android to Google Play Beta Track via Fastlane
    dir: android
    cmds:
      - fastlane beta

  fastlane:android:build:
    desc: Build Android release bundle via Fastlane (no upload)
    dir: android
    cmds:
      - fastlane build_release

  fastlane:android:validate:
    desc: Validate Android bundle and credentials
    dir: android
    cmds:
      - fastlane validate

  # -----------------------------------------------------------------------------
  # Fastlane - iOS

  fastlane:ios:beta:
    desc: Deploy iOS to TestFlight via Fastlane
    dir: ios
    cmds:
      - fastlane beta

  fastlane:ios:release:
    desc: Deploy iOS to App Store via Fastlane
    dir: ios
    cmds:
      - fastlane release

  fastlane:ios:build:
    desc: Build iOS IPA via Fastlane (no upload)
    dir: ios
    cmds:
      - fastlane build_release

  fastlane:ios:validate:
    desc: Validate iOS credentials and configuration
    dir: ios
    cmds:
      - fastlane validate

  fastlane:ios:setup:
    desc: Setup iOS keychain for CI
    dir: ios
    cmds:
      - fastlane setup_keychain

  fastlane:ios:cleanup:
    desc: Clean up iOS CI artifacts
    dir: ios
    cmds:
      - fastlane cleanup

  # -----------------------------------------------------------------------------
  # Flutter server

  serve:web:
    desc: Serve the application locally
    cmds:
      - flutter run -d chrome

  serve:web:clean:
    desc: Clean and serve the application
    cmds:
      - task: clean
      - task: get
      - task: serve:web

  dev:
    desc: Run the application in dev mode with Chromium
    cmds:
      - CHROME_EXECUTABLE=/snap/bin/chromium flutter run -d chrome

  serve:linux:
    desc: Serve the application on Linux
    cmds:
      - flutter run -d linux

  serve:windows:
    desc: Serve the application on Windows
    cmds:
      - flutter run -d windows

  serve:macos:
    desc: Serve the application on macOS
    cmds:
      - flutter run -d macos

  serve:android:
    desc: Serve the application on Android
    cmds:
      - flutter run -d 'SM S901U'

  serve:ios:
    desc: Serve the application on iOS simulator (auto-selects available simulator)
    cmds:
      - task: get
      - cd ios && pod install
      - |
        # Auto-select iOS simulator - find booted simulator or boot the first available one
        BOOTED_SIM=$(xcrun simctl list devices booted | grep -E "iPhone|iPad" | head -1 | awk -F'[()]' '{print $2}')
        if [ -z "$BOOTED_SIM" ]; then
          # No booted simulator, find and boot the first available iPhone simulator
          SIM_ID=$(xcrun simctl list devices available | grep -E "iPhone" | head -1 | awk -F'[()]' '{print $2}')
          if [ -n "$SIM_ID" ]; then
            echo "Booting iOS simulator: $SIM_ID"
            xcrun simctl boot "$SIM_ID" 2>/dev/null || true
            sleep 2
          fi
        fi
      - flutter run

  serve:ios:clean:
    desc: Clean and serve the application on iOS simulator
    cmds:
      - task: clean
      - task: get
      - cd ios && pod install
      - |
        # Auto-select iOS simulator - find booted simulator or boot the first available one
        BOOTED_SIM=$(xcrun simctl list devices booted | grep -E "iPhone|iPad" | head -1 | awk -F'[()]' '{print $2}')
        if [ -z "$BOOTED_SIM" ]; then
          # No booted simulator, find and boot the first available iPhone simulator
          SIM_ID=$(xcrun simctl list devices available | grep -E "iPhone" | head -1 | awk -F'[()]' '{print $2}')
          if [ -n "$SIM_ID" ]; then
            echo "Booting iOS simulator: $SIM_ID"
            xcrun simctl boot "$SIM_ID" 2>/dev/null || true
            sleep 2
          fi
        fi
      - flutter run

  # -----------------------------------------------------------------------------
  # Environment-Specific Tasks

  serve:dev:
    desc: Run the application in development environment
    cmds:
      - flutter run --dart-define=APP_ENV=dev

  serve:dev:web:
    desc: Run the web application in development environment
    cmds:
      - flutter run -d chrome --dart-define=APP_ENV=dev

  serve:preview:
    desc: Run the application in preview environment
    cmds:
      - flutter run --dart-define=APP_ENV=preview

  serve:preview:web:
    desc: Run the web application in preview environment
    cmds:
      - flutter run -d chrome --dart-define=APP_ENV=preview

  serve:prod:
    desc: Run the application in production environment
    cmds:
      - flutter run --dart-define=APP_ENV=prod

  serve:prod:web:
    desc: Run the web application in production environment
    cmds:
      - flutter run -d chrome --dart-define=APP_ENV=prod

  build:web:dev:
    desc: Build the web application for development environment
    cmds:
      - flutter build web --dart-define=APP_ENV=dev

  build:web:preview:
    desc: Build the web application for preview environment
    cmds:
      - flutter build web --dart-define=APP_ENV=preview

  build:web:prod:
    desc: Build the web application for production environment
    cmds:
      - flutter build web --dart-define=APP_ENV=prod

  test:dev:
    desc: Run tests in development environment
    cmds:
      - flutter test --dart-define=APP_ENV=dev

  test:preview:
    desc: Run tests in preview environment
    cmds:
      - flutter test --dart-define=APP_ENV=preview

  test:prod:
    desc: Run tests in production environment
    cmds:
      - flutter test --dart-define=APP_ENV=prod

  # -----------------------------------------------------------------------------
  # Deploy

  deploy:
    desc: Deploy the application to Firebase Hosting
    deps:
      - build:web
    cmds:
      - firebase deploy --only hosting

  # -----------------------------------------------------------------------------
  # Firebase Hosting

  hosting:deploy:
    desc: Deploy to Firebase Hosting (uses Bitwarden Secrets Manager token)
    cmds:
      - firebase deploy --only hosting --token "$(bws secret get FIREBASE_CI_TOKEN)"

  hosting:preview:
    desc: Deploy preview channel
    cmds:
      - firebase hosting:channel:deploy pr-${{PR_NUMBER}} # Manual for now

  # -----------------------------------------------------------------------------
  # Validation and Maintenance

  validate:
    desc: Validate code quality, linting, tests, and build
    cmds:
      - task: analyze
      - task: format:check
      - task: lint
      - task: test
      - task: build:web

  validate:fix:
    desc: Fix code quality, linting issues, and format code
    cmds:
      - task: format
      - task: lint:fix
      - task: analyze
      - task: test

  clean:
    desc: Clean the Flutter build cache
    cmds:
      - flutter clean

  analyze:
    desc: Analyze the Flutter code
    cmds:
      - flutter analyze

  test:
    desc: Run Flutter tests (excludes level solver tests)
    cmds:
      - flutter test --exclude-tags=level-solver

  test:levels:
    desc: Run level solver tests only (for when adding new levels)
    cmds:
      - flutter test test/level_validation_test.dart

  test:all:
    desc: Run all tests including level solver tests
    cmds:
      - flutter test

  format:
    desc: Format the Flutter code
    cmds:
      - dart format .

  format:check:
    desc: Check if Flutter code is formatted
    cmds:
      - find lib test -name "*.dart" -not -name "firebase_options.dart" -exec dart format --output=none --set-exit-if-changed {} \;

  lint:
    desc: Run Flutter linting
    cmds:
      - flutter analyze --no-fatal-infos --no-fatal-warnings

  lint:fix:
    desc: Fix Flutter linting issues
    cmds:
      - dart fix --apply

  # -----------------------------------------------------------------------------
  # Icons

  generate_icons:
    desc: Generate app icons and favicon for all platforms using flutter_launcher_icons
    cmds:
      - dart run flutter_launcher_icons

  update_icons:
    desc: Update app icons using flutter_launcher_icons
    cmds:
      - flutter pub run flutter_launcher_icons:main

  # -----------------------------------------------------------------------------
  # Dependencies

  get:
    desc: Get Flutter dependencies
    cmds:
      - flutter pub get

  upgrade:
    desc: Upgrade Flutter dependencies
    cmds:
      - flutter pub upgrade

  # -----------------------------------------------------------------------------
  # Firebase

  firebase:login:
    desc: Log in to Firebase
    cmds:
      - firebase login

  firebase:init:
    desc: Initialize Firebase in the project
    cmds:
      - firebase init

  firebase:emulators:start:
    desc: Start Firebase emulators
    cmds:
      - firebase emulators:start

  firebase:emulators:exec:
    desc: Execute a command with Firebase emulators running
    cmds:
      - firebase emulators:exec "{{.CLI_ARGS}}"

  firebase:functions:deploy:
    desc: Deploy Firebase functions
    cmds:
      - firebase deploy --only functions

  firebase:firestore:rules:deploy:
    desc: Deploy Firestore security rules
    cmds:
      - firebase deploy --only firestore:rules

  firebase:storage:rules:deploy:
    desc: Deploy Cloud Storage security rules
    cmds:
      - firebase deploy --only storage:rules

  firebase:hosting:deploy:
    desc: Deploy Firebase Hosting
    cmds:
      - firebase deploy --only hosting

  firebase:deploy:all:
    desc: Deploy all Firebase services
    cmds:
      - firebase deploy

  # -----------------------------------------------------------------------------
  # Firebase - FlutterFire

  firebase:configure:
    desc: Configure Firebase using FlutterFire CLI for local development (requires Firebase CLI auth)
    cmds:
      - flutterfire configure --project=parable-bloom --platforms=android,ios,web,linux,macos,windows --yes

  firebase:configure:android:
    desc: Configure Firebase for Android only (local development)
    cmds:
      - flutterfire configure --project=parable-bloom --platforms=android --yes

  firebase:configure:ios:
    desc: Configure Firebase for iOS only (local development)
    cmds:
      - flutterfire configure --project=parable-bloom --platforms=ios --yes

  firebase:configure:web:
    desc: Configure Firebase for Web only (local development)
    cmds:
      - flutterfire configure --project=parable-bloom --platforms=web --yes

  firebase:configure:linux:
    desc: Configure Firebase for Linux only (local development)
    cmds:
      - flutterfire configure --project=parable-bloom --platforms=linux --yes

  firebase:configure:macos:
    desc: Configure Firebase for macOS only (local development)
    cmds:
      - flutterfire configure --project=parable-bloom --platforms=macos --yes

  firebase:configure:windows:
    desc: Configure Firebase for Windows only (local development)
    cmds:
      - flutterfire configure --project=parable-bloom --platforms=windows --yes

  # -----------------------------------------------------------------------------
  # Hugo Site

  hugo:install:
    desc: Install Hugo extended edition via Go
    cmds:
      - go install -tags extended github.com/gohugoio/hugo@latest

  hugo:serve:
    desc: Start Hugo development server
    dir: tools/hugo-site
    cmds:
      - hugo server -D

  hugo:build:
    desc: Build Hugo site to docs/
    dir: tools/hugo-site
    cmds:
      - hugo --minify

  hugo:new:
    desc: Create new content page (usage - task hugo:new PAGE=privacy)
    dir: tools/hugo-site
    cmds:
      - hugo new content {{.PAGE}}.md
