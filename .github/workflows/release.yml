name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  firebase-config:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6.0.1

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Cache pub
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('pubspec.lock') }}
          restore-keys: ${{ runner.os }}-pub-

      - name: Install Firebase & FlutterFire CLI
        env:
          FIREBASE_CI_TOKEN: ${{ secrets.FIREBASE_CI_TOKEN }}
        run: |
          npm install -g firebase-tools
          dart pub global activate flutterfire_cli
          export PATH="$PATH:$HOME/.pub-cache/bin"
          flutterfire configure \
            --project=parable-bloom \
            --platforms=android,linux,windows,web \
            --yes \
            --out=lib/firebase_options.dart \
            --token="$FIREBASE_CI_TOKEN"

      - name: Upload firebase_options.dart
        uses: actions/upload-artifact@v6
        with:
          name: firebase_options
          path: lib/firebase_options.dart

  build:
    needs: firebase-config
    strategy:
      matrix:
        include:
          - platform: web
            os: ubuntu-latest
          - platform: linux
            os: ubuntu-latest
          - platform: windows
            os: windows-latest
          - platform: android
            os: ubuntu-latest
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v6.0.1
      - name: Download firebase_options.dart
        uses: actions/download-artifact@v7
        with:
          name: firebase_options
          path: lib
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Cache pub
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('pubspec.lock') }}
          restore-keys: ${{ runner.os }}-pub-

      - name: Set up Task
        uses: arduino/setup-task@v2

      - name: Install Linux dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libx11-dev pkg-config cmake ninja-build libblkid-dev

      - name: Set up Java
        if: matrix.platform == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Cache Gradle
        if: matrix.platform == 'android'
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: ${{ runner.os }}-gradle-

      - name: Fetch secrets from Bitwarden
        if: matrix.platform == 'android'
        uses: bitwarden/sm-action@v2
        with:
          access_token: ${{ secrets.BWS_ACCESS_TOKEN }}
          secrets: |
            505a0079-856a-4b9b-ba40-b3c9002a4ef7 > PARABLE_BLOOM_ANDROID_KEYSTORE
            c5a7d4cc-eb95-4c1f-bfa5-b3c9002a798e > PARABLE_BLOOM_ANDROID_KEY_ALIAS
            5f57faf9-5fde-4f7a-8823-b3c9002a8e77 > PARABLE_BLOOM_ANDROID_KEY_PASSWORD
            81045dc0-4686-468e-8688-b3c9002c2a00 > PARABLE_BLOOM_ANDROID_STORE_PASSWORD
            d5507ff8-ab4f-4724-bf64-b3c9006d87fc > PARABLE_BLOOM_GOOGLE_PLAY_SERVICE_ACCOUNT_JSON
            364a1b15-ba12-407a-ad77-b3c9007c8c7e > PARABLE_BLOOM_GOOGLE_SERVICES_JSON

      - name: Decode and setup keystore
        if: matrix.platform == 'android'
        run: |
          echo "$PARABLE_BLOOM_ANDROID_KEYSTORE" | base64 -d > /tmp/parable-bloom.jks
          echo "ANDROID_KEYSTORE_PATH=/tmp/parable-bloom.jks" >> $GITHUB_ENV
          echo "ANDROID_KEY_ALIAS=$PARABLE_BLOOM_ANDROID_KEY_ALIAS" >> $GITHUB_ENV
          echo "ANDROID_KEY_PASSWORD=$PARABLE_BLOOM_ANDROID_KEY_PASSWORD" >> $GITHUB_ENV
          echo "ANDROID_STORE_PASSWORD=$PARABLE_BLOOM_ANDROID_STORE_PASSWORD" >> $GITHUB_ENV

      - name: Write google-services.json
        if: matrix.platform == 'android'
        run: |
          echo "$PARABLE_BLOOM_GOOGLE_SERVICES_JSON" | base64 -d > android/app/google-services.json

      - name: Install dependencies
        run: task get

      - name: Set Android build version
        if: matrix.platform == 'android'
        run: |
          BUILD_NAME="${GITHUB_REF_NAME#v}"
          BUILD_NUMBER=$((GITHUB_RUN_NUMBER * 10 + GITHUB_RUN_ATTEMPT))
          echo "BUILD_NAME=$BUILD_NAME" >> $GITHUB_ENV
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV

      - name: Build web
        if: matrix.platform == 'web'
        run: task build:web

      - name: Build Linux
        if: matrix.platform == 'linux'
        run: task build:linux

      - name: Build Windows
        if: matrix.platform == 'windows'
        run: task build:windows

      - name: Build Android App Bundle
        if: matrix.platform == 'android'
        run: task build:android BUILD_NAME="$BUILD_NAME" BUILD_NUMBER="$BUILD_NUMBER"

      - name: Package web build
        if: matrix.platform == 'web'
        run: |
          cd build/web
          tar -czf ../../parable-bloom-web-${{ github.ref_name }}.tar.gz *

      - name: Package Linux build
        if: matrix.platform == 'linux'
        run: |
          cd build/linux/x64/release/bundle
          tar -czf ../../../../../parable-bloom-linux-${{ github.ref_name }}.tar.gz *

      - name: Package Windows build
        if: matrix.platform == 'windows'
        run: |
          cd build\windows\x64\runner\Release
          Compress-Archive -Path * -DestinationPath $env:GITHUB_WORKSPACE\parable-bloom-windows-${{ github.ref_name }}.zip

      - name: Check Play upload availability
        if: matrix.platform == 'android'
        id: play
        run: |
          if [ -n "${PARABLE_BLOOM_GOOGLE_PLAY_SERVICE_ACCOUNT_JSON}" ]; then
            echo "upload=true" >> $GITHUB_OUTPUT
          else
            echo "upload=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Ruby for Fastlane
        if: matrix.platform == 'android'
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: android

      - name: Install Fastlane
        if: matrix.platform == 'android'
        run: |
          cd android
          gem install fastlane

      - name: Deploy to Google Play (Internal Testing)
        if: matrix.platform == 'android' && steps.play.outputs.upload == 'true'
        run: |
          # Decode service account JSON to file
          echo "$PARABLE_BLOOM_GOOGLE_PLAY_SERVICE_ACCOUNT_JSON" | base64 -d > /tmp/service-account.json
          
          cd android
          fastlane deploy
        env:
          GOOGLE_PLAY_SERVICE_ACCOUNT_PATH: /tmp/service-account.json
          GOOGLE_PLAY_RELEASE_STATUS: draft

      - name: Skip Play upload (service account not configured)
        if: matrix.platform == 'android' && steps.play.outputs.upload != 'true'
        run: echo "Skipping Play Console upload because PARABLE_BLOOM_GOOGLE_PLAY_SERVICE_ACCOUNT_JSON is not set."

      - name: Upload web artifact
        if: matrix.platform == 'web'
        uses: actions/upload-artifact@v6
        with:
          name: web-build
          path: parable-bloom-web-${{ github.ref_name }}.tar.gz

      - name: Upload Linux artifact
        if: matrix.platform == 'linux'
        uses: actions/upload-artifact@v6
        with:
          name: linux-build
          path: parable-bloom-linux-${{ github.ref_name }}.tar.gz

      - name: Upload Windows artifact
        if: matrix.platform == 'windows'
        uses: actions/upload-artifact@v6
        with:
          name: windows-build
          path: parable-bloom-windows-${{ github.ref_name }}.zip

      - name: Upload Android artifact
        if: matrix.platform == 'android'
        uses: actions/upload-artifact@v6
        with:
          name: android-build
          path: build/app/outputs/bundle/release/app-release.aab

      - name: Cleanup
        if: matrix.platform == 'android' && always()
        run: |
          rm -f /tmp/parable-bloom.jks
          rm -f /tmp/service-account.json

  build-disabled:
    if: false # Temporarily disabled until configurations are ready
    needs: firebase-config
    strategy:
      matrix:
        include:
          - platform: macos
            os: macos-latest
          - platform: ios
            os: macos-latest
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v6.0.1
      - name: Download firebase_options.dart
        if: matrix.platform == 'macos'
        uses: actions/download-artifact@v7
        with:
          name: firebase_options
          path: lib
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Cache pub
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('pubspec.lock') }}
          restore-keys: ${{ runner.os }}-pub-

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: |
            ios/Pods
            macos/Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('ios/Podfile.lock', 'macos/Podfile.lock') }}
          restore-keys: ${{ runner.os }}-pods-

      - name: Fetch secrets from Bitwarden
        if: matrix.platform == 'ios'
        uses: bitwarden/sm-action@v2
        with:
          access_token: ${{ secrets.BWS_ACCESS_TOKEN }}
          secrets: |
            PARABLE_BLOOM_IOS_CERTIFICATE_P12
            PARABLE_BLOOM_IOS_CERTIFICATE_PASSWORD
            PARABLE_BLOOM_IOS_PROVISIONING_PROFILE
            PARABLE_BLOOM_IOS_PROVISIONING_PROFILE_UUID
            PARABLE_BLOOM_IOS_TEAM_ID
            PARABLE_BLOOM_APP_STORE_CONNECT_KEY_ID
            PARABLE_BLOOM_APP_STORE_CONNECT_ISSUER_ID
            PARABLE_BLOOM_APP_STORE_CONNECT_KEY

      - name: Setup certificates and profiles
        if: matrix.platform == 'ios'
        run: |
          # Decode certificate
          echo "$PARABLE_BLOOM_IOS_CERTIFICATE_P12" | base64 -d > /tmp/distribution-cert.p12

          # Decode provisioning profile
          echo "$PARABLE_BLOOM_IOS_PROVISIONING_PROFILE" | base64 -d > /tmp/profile.mobileprovision

          # Create App Store Connect API key
          mkdir -p ~/private_keys
          echo "$PARABLE_BLOOM_APP_STORE_CONNECT_KEY" | base64 -d > ~/private_keys/AuthKey_${PARABLE_BLOOM_APP_STORE_CONNECT_KEY_ID}.p8

          # Set environment variables
          echo "IOS_CERTIFICATE_PATH=/tmp/distribution-cert.p12" >> $GITHUB_ENV
          echo "IOS_CERTIFICATE_PASSWORD=$PARABLE_BLOOM_IOS_CERTIFICATE_PASSWORD" >> $GITHUB_ENV
          echo "IOS_PROVISIONING_PROFILE_PATH=/tmp/profile.mobileprovision" >> $GITHUB_ENV
          echo "IOS_TEAM_ID=$PARABLE_BLOOM_IOS_TEAM_ID" >> $GITHUB_ENV
          echo "APP_STORE_CONNECT_KEY_ID=$PARABLE_BLOOM_APP_STORE_CONNECT_KEY_ID" >> $GITHUB_ENV
          echo "APP_STORE_CONNECT_ISSUER_ID=$PARABLE_BLOOM_APP_STORE_CONNECT_ISSUER_ID" >> $GITHUB_ENV
          echo "APP_STORE_CONNECT_API_KEY_PATH=~/private_keys/AuthKey_${PARABLE_BLOOM_APP_STORE_CONNECT_KEY_ID}.p8" >> $GITHUB_ENV
          echo "KEYCHAIN_NAME=ci.keychain" >> $GITHUB_ENV
          echo "KEYCHAIN_PASSWORD=ci_password" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          flutter pub get
          if [ "${{ matrix.platform }}" == "ios" ]; then
            cd ios && pod install
          fi

      - name: Build macOS
        if: matrix.platform == 'macos'
        run: flutter build macos --release

      - name: Setup Ruby for Fastlane
        if: matrix.platform == 'ios'
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: ios

      - name: Install Fastlane
        if: matrix.platform == 'ios'
        run: |
          cd ios
          gem install fastlane

      - name: Deploy to TestFlight
        if: matrix.platform == 'ios'
        run: |
          cd ios
          fastlane beta

      - name: Package macOS build
        if: matrix.platform == 'macos'
        run: |
          cd build/macos/Build/Products/Release
          tar -czf ../../../../../parable-bloom-macos-${{ github.ref_name }}.tar.gz ParableBloom.app

      - name: Upload macOS artifact
        if: matrix.platform == 'macos'
        uses: actions/upload-artifact@v6
        with:
          name: macos-build
          path: parable-bloom-macos-${{ github.ref_name }}.tar.gz

      - name: Upload iOS artifact
        if: matrix.platform == 'ios'
        uses: actions/upload-artifact@v6
        with:
          name: ios-build
          path: build/ios/ipa/*.ipa

      - name: Cleanup
        if: matrix.platform == 'ios' && always()
        run: |
          rm -f /tmp/distribution-cert.p12
          rm -f /tmp/profile.mobileprovision
          rm -rf ~/private_keys
          cd ios && fastlane cleanup


  release:
    needs:
      [
        firebase-config,
        build,
      ]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download Linux build
        uses: actions/download-artifact@v4
        with:
          name: linux-build
          path: ./artifacts/

      - name: Download Windows build
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: ./artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            artifacts/parable-bloom-linux-${{ github.ref_name }}.tar.gz
            artifacts/parable-bloom-windows-${{ github.ref_name }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
