name: Publish

on:
  push:
    tags:
      - "v*"
      - "level-builder-v*"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  firebase-config:
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6
      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun
        uses: actions/cache@v5
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Cache Nx
        uses: actions/cache@v5
        with:
          path: .nx/cache
          key: ${{ runner.os }}-nx-${{ hashFiles('bun.lock', 'nx.json') }}-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-nx-${{ hashFiles('bun.lock', 'nx.json') }}-
            ${{ runner.os }}-nx-

      - name: Install dependencies
        run: bun install

      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          version: 3.x
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}

      - name: Install Firebase & FlutterFire CLI
        run: |
          bun add -g firebase-tools
          dart pub global activate flutterfire_cli
          export PATH="$PATH:$HOME/.pub-cache/bin"
          task firebase:configure:ci

      - name: Upload firebase_options.dart
        uses: actions/upload-artifact@v6
        with:
          name: firebase_options
          path: apps/parable-bloom/lib/firebase_options.dart

  build-game:
    needs: firebase-config
    strategy:
      matrix:
        platform: [web, android]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v6
      - name: Download firebase_options.dart
        uses: actions/download-artifact@v7
        with:
          name: firebase_options
          path: apps/parable-bloom/lib

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun
        uses: actions/cache@v5
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Cache Nx
        uses: actions/cache@v5
        with:
          path: .nx/cache
          key: ${{ runner.os }}-nx-${{ hashFiles('bun.lock', 'nx.json') }}-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-nx-${{ hashFiles('bun.lock', 'nx.json') }}-
            ${{ runner.os }}-nx-

      - name: Install dependencies
        run: bun install

      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          version: 3.x
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          cache: true

      - name: Set up Java
        if: matrix.platform == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "17"

      - name: Fetch secrets from Bitwarden
        if: matrix.platform == 'android'
        uses: bitwarden/sm-action@v2
        with:
          access_token: ${{ secrets.BWS_ACCESS_TOKEN }}
          secrets: |
            505a0079-856a-4b9b-ba40-b3c9002a4ef7 > PARABLE_BLOOM_ANDROID_KEYSTORE
            c5a7d4cc-eb95-4c1f-bfa5-b3c9002a798e > PARABLE_BLOOM_ANDROID_KEY_ALIAS
            5f57faf9-5fde-4f7a-8823-b3c9002a8e77 > PARABLE_BLOOM_ANDROID_KEY_PASSWORD
            81045dc0-4686-468e-8688-b3c9002c2a00 > PARABLE_BLOOM_ANDROID_STORE_PASSWORD
            d5507ff8-ab4f-4724-bf64-b3c9006d87fc > PARABLE_BLOOM_GOOGLE_PLAY_SERVICE_ACCOUNT_JSON

      - name: Decode and setup keystore
        if: matrix.platform == 'android'
        run: |
          echo "$PARABLE_BLOOM_ANDROID_KEYSTORE" | base64 -d > /tmp/parable-bloom.jks
          echo "ANDROID_KEYSTORE_PATH=/tmp/parable-bloom.jks" >> $GITHUB_ENV
          echo "ANDROID_KEY_ALIAS=$PARABLE_BLOOM_ANDROID_KEY_ALIAS" >> $GITHUB_ENV
          echo "ANDROID_KEY_PASSWORD=$PARABLE_BLOOM_ANDROID_KEY_PASSWORD" >> $GITHUB_ENV
          echo "ANDROID_STORE_PASSWORD=$PARABLE_BLOOM_ANDROID_STORE_PASSWORD" >> $GITHUB_ENV

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}

      - name: Build Game
        run: bunx nx run parable-bloom:release-${{ matrix.platform }}

      - name: Deploy to Firebase Hosting
        if: matrix.platform == 'web'
        run: bunx nx run parable-bloom:deploy-web

      - name: Deploy to Google Play (Internal)
        if: matrix.platform == 'android'
        run: |
          echo "$PARABLE_BLOOM_GOOGLE_PLAY_SERVICE_ACCOUNT_JSON" | base64 -d > /tmp/service-account.json
          export GOOGLE_PLAY_SERVICE_ACCOUNT_PATH=/tmp/service-account.json
          bunx nx run parable-bloom:deploy-android

      - name: Upload Artifact
        uses: actions/upload-artifact@v6
        with:
          name: game-${{ matrix.platform }}
          path: apps/parable-bloom/build/app/outputs/bundle/release/app-release.aab

  build-level-builder:
    if: startsWith(github.ref, 'refs/tags/level-builder-v')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      matrix:
        goos: [linux, windows, darwin]
        goarch: [amd64, arm64]
    steps:
      - uses: actions/checkout@v6
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25"

      - name: Build Level Builder
        run: |
          GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} go build -o dist/level-builder-${{ matrix.goos }}-${{ matrix.goarch }} ./tools/level-builder

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        with:
          files: dist/level-builder-${{ matrix.goos }}-${{ matrix.goarch }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
