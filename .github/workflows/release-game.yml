name: Release Game

on:
  release:
    types: [published]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  firebase-config:
    if: startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Cache pub
        uses: actions/cache@v5
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('pubspec.lock') }}
          restore-keys: ${{ runner.os }}-pub-

      - name: Install Firebase & FlutterFire CLI
        env:
          FIREBASE_CI_TOKEN: ${{ secrets.FIREBASE_CI_TOKEN }}
        run: |
          if [ -z "$FIREBASE_CI_TOKEN" ]; then
            echo "::error::FIREBASE_CI_TOKEN is empty! Please check GitHub Secrets for this repository."
            exit 1
          fi
          npm install -g firebase-tools
          dart pub global activate flutterfire_cli
          export PATH="$PATH:$HOME/.pub-cache/bin"
          flutterfire configure \
            --project=parable-bloom \
            --platforms=android,linux,windows,web \
            --yes \
            --out=lib/firebase_options.dart \
            --token="$FIREBASE_CI_TOKEN"

      - name: Upload firebase_options.dart
        uses: actions/upload-artifact@v6
        with:
          name: firebase_options
          path: lib/firebase_options.dart

  build:
    needs: firebase-config
    strategy:
      matrix:
        include:
          - platform: web
            os: ubuntu-latest
          - platform: linux
            os: ubuntu-latest
          - platform: windows
            os: windows-latest
          - platform: android
            os: ubuntu-latest
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v6
      - name: Download firebase_options.dart
        uses: actions/download-artifact@v7
        with:
          name: firebase_options
          path: lib
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Cache pub
        uses: actions/cache@v5
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('pubspec.lock') }}
          restore-keys: ${{ runner.os }}-pub-

      - name: Set up Task
        uses: arduino/setup-task@v2

      - name: Install Linux dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libx11-dev pkg-config cmake ninja-build libblkid-dev

      - name: Set up Java
        if: matrix.platform == 'android'
        uses: actions/setup-java@v5
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Cache Gradle
        if: matrix.platform == 'android'
        uses: actions/cache@v5
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: ${{ runner.os }}-gradle-

      - name: Fetch secrets from Bitwarden
        if: matrix.platform == 'android'
        uses: bitwarden/sm-action@v2
        with:
          access_token: ${{ secrets.BWS_ACCESS_TOKEN }}
          secrets: |
            505a0079-856a-4b9b-ba40-b3c9002a4ef7 > PARABLE_BLOOM_ANDROID_KEYSTORE
            c5a7d4cc-eb95-4c1f-bfa5-b3c9002a798e > PARABLE_BLOOM_ANDROID_KEY_ALIAS
            5f57faf9-5fde-4f7a-8823-b3c9002a8e77 > PARABLE_BLOOM_ANDROID_KEY_PASSWORD
            81045dc0-4686-468e-8688-b3c9002c2a00 > PARABLE_BLOOM_ANDROID_STORE_PASSWORD
            d5507ff8-ab4f-4724-bf64-b3c9006d87fc > PARABLE_BLOOM_GOOGLE_PLAY_SERVICE_ACCOUNT_JSON
            364a1b15-ba12-407a-ad77-b3c9007c8c7e > PARABLE_BLOOM_GOOGLE_SERVICES_JSON

      - name: Decode and setup keystore
        if: matrix.platform == 'android'
        run: |
          echo "$PARABLE_BLOOM_ANDROID_KEYSTORE" | base64 -d > /tmp/parable-bloom.jks
          echo "ANDROID_KEYSTORE_PATH=/tmp/parable-bloom.jks" >> $GITHUB_ENV
          echo "ANDROID_KEY_ALIAS=$PARABLE_BLOOM_ANDROID_KEY_ALIAS" >> $GITHUB_ENV
          echo "ANDROID_KEY_PASSWORD=$PARABLE_BLOOM_ANDROID_KEY_PASSWORD" >> $GITHUB_ENV
          echo "ANDROID_STORE_PASSWORD=$PARABLE_BLOOM_ANDROID_STORE_PASSWORD" >> $GITHUB_ENV

      - name: Write google-services.json
        if: matrix.platform == 'android'
        run: |
          echo "$PARABLE_BLOOM_GOOGLE_SERVICES_JSON" | base64 -d > android/app/google-services.json

      - name: Install dependencies
        run: task flutter:get

      - name: Set Android build version
        if: matrix.platform == 'android'
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            BUILD_NAME="${GITHUB_REF_NAME#v}"
          else
            BUILD_NAME="0.0.0"
          fi
          # Strip build metadata if present
          BUILD_NAME="${BUILD_NAME%+*}"

          BUILD_NUMBER=$((GITHUB_RUN_NUMBER * 10 + GITHUB_RUN_ATTEMPT))
          echo "BUILD_NAME=$BUILD_NAME" >> $GITHUB_ENV
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV

      - name: Build web
        if: matrix.platform == 'web'
        run: task release:web

      - name: Build Linux
        if: matrix.platform == 'linux'
        run: task release:linux

      - name: Build Windows
        if: matrix.platform == 'windows'
        run: task release:windows

      - name: Build Android App Bundle
        if: matrix.platform == 'android'
        run: task release:android BUILD_NAME="$BUILD_NAME" BUILD_NUMBER="$BUILD_NUMBER"

      - name: Package web build
        if: matrix.platform == 'web'
        run: |
          cd build/web
          tar -czf ../../parable-bloom-web-${{ github.ref_name }}.tar.gz *

      - name: Package Linux build
        if: matrix.platform == 'linux'
        run: |
          cd build/linux/x64/release/bundle
          tar -czf ../../../../../parable-bloom-linux-${{ github.ref_name }}.tar.gz *

      - name: Package Windows build
        if: matrix.platform == 'windows'
        run: |
          cd build\windows\x64\runner\Release
          Compress-Archive -Path * -DestinationPath $env:GITHUB_WORKSPACE\parable-bloom-windows-${{ github.ref_name }}.zip

      - name: Check Play upload availability
        if: matrix.platform == 'android'
        id: play
        run: |
          if [ -n "${PARABLE_BLOOM_GOOGLE_PLAY_SERVICE_ACCOUNT_JSON}" ]; then
            echo "upload=true" >> $GITHUB_OUTPUT
          else
            echo "upload=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Ruby for Fastlane
        if: matrix.platform == 'android'
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: android

      - name: Install Fastlane
        if: matrix.platform == 'android'
        run: |
          cd android
          gem install fastlane

      - name: Deploy to Google Play (Internal Testing)
        if: matrix.platform == 'android' && steps.play.outputs.upload == 'true' && startsWith(github.ref, 'refs/tags/v')
        continue-on-error: true
        run: |
          echo "$PARABLE_BLOOM_GOOGLE_PLAY_SERVICE_ACCOUNT_JSON" | base64 -d > /tmp/service-account.json
          cd android
          fastlane deploy
        env:
          GOOGLE_PLAY_SERVICE_ACCOUNT_PATH: /tmp/service-account.json
          GOOGLE_PLAY_RELEASE_STATUS: draft

      - name: Upload web artifact
        if: matrix.platform == 'web'
        uses: actions/upload-artifact@v6
        with:
          name: web-build
          path: parable-bloom-web-${{ github.ref_name }}.tar.gz

      - name: Upload Linux artifact
        if: matrix.platform == 'linux'
        uses: actions/upload-artifact@v6
        with:
          name: linux-build
          path: parable-bloom-linux-${{ github.ref_name }}.tar.gz

      - name: Upload Windows artifact
        if: matrix.platform == 'windows'
        uses: actions/upload-artifact@v6
        with:
          name: windows-build
          path: parable-bloom-windows-${{ github.ref_name }}.zip

      - name: Upload Android artifact
        if: matrix.platform == 'android'
        uses: actions/upload-artifact@v6
        with:
          name: android-build
          path: build/app/outputs/bundle/release/app-release.aab

      - name: Cleanup
        if: matrix.platform == 'android' && always()
        run: |
          rm -f /tmp/parable-bloom.jks
          rm -f /tmp/service-account.json

  upload-assets:
    needs: [firebase-config, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download Linux build
        uses: actions/download-artifact@v7
        with:
          name: linux-build
          path: ./artifacts/

      - name: Download Windows build
        uses: actions/download-artifact@v7
        with:
          name: windows-build
          path: ./artifacts/

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/parable-bloom-linux-${{ github.ref_name }}.tar.gz
            artifacts/parable-bloom-windows-${{ github.ref_name }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
