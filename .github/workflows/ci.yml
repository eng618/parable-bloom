name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      flutter: ${{ steps.filter.outputs.flutter }}
      level-builder: ${{ steps.filter.outputs.level-builder }}
      hugo: ${{ steps.filter.outputs.hugo }}
      firebase: ${{ steps.filter.outputs.firebase }}
    steps:
      - uses: actions/checkout@v6
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            flutter:
              - 'lib/**'
              - 'assets/**'
              - 'pubspec.*'
              - 'analysis_options.yaml'
              - 'test/**'
            level-builder:
              - 'tools/level-builder/**'
            hugo:
              - 'tools/hugo-site/**'
            firebase:
              - 'firebase.json'
              - 'firestore.rules'
              - '.firebaserc'

  lint:
    needs: changes
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Flutter
        if: needs.changes.outputs.flutter == 'true'
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Set up Go
        if: needs.changes.outputs.level-builder == 'true'
        uses: actions/setup-go@v6
        with:
          go-version: '1.25'

      - name: Set up Task
        uses: arduino/setup-task@v2

      - name: Install golangci-lint
        if: needs.changes.outputs.level-builder == 'true'
        run: |
          go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@latest

      - name: Run Analysis
        run: task analyze:all

      - name: Check Formatting
        run: task format:check:all

  test:
    needs: [changes, lint]
    runs-on: ubuntu-latest
    env:
      HAS_CODACY_TOKEN: ${{ secrets.CODACY_PROJECT_TOKEN != '' }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Flutter
        if: needs.changes.outputs.flutter == 'true'
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Set up Go
        if: needs.changes.outputs.level-builder == 'true'
        uses: actions/setup-go@v6
        with:
          go-version: '1.25'

      - name: Set up Task
        uses: arduino/setup-task@v2

      - name: Run Tests
        run: task test:all

      - name: Run Codacy Coverage Reporter
        uses: codacy/codacy-coverage-reporter-action@v1.3.0
        if: env.HAS_CODACY_TOKEN == 'true'
        continue-on-error: true
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
          coverage-reports: coverage/lcov.info,tools/level-builder/coverage.out

  build:
    needs: [changes, lint]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Flutter
        if: needs.changes.outputs.flutter == 'true'
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Set up Go
        if: needs.changes.outputs.level-builder == 'true'
        uses: actions/setup-go@v6
        with:
          go-version: '1.25'

      - name: Setup Hugo
        if: needs.changes.outputs.hugo == 'true'
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'
          extended: true

      - name: Set up Task
        uses: arduino/setup-task@v2

      - name: Install Firebase & FlutterFire CLI
        if: needs.changes.outputs.flutter == 'true' || needs.changes.outputs.firebase == 'true'
        run: |
          npm install -g firebase-tools
          dart pub global activate flutterfire_cli
          echo "$HOME/.pub-cache/bin" >> $GITHUB_PATH

      - name: Generate firebase_options.dart
        if: needs.changes.outputs.flutter == 'true'
        timeout-minutes: 5
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_CI_TOKEN }}
        run: |
          if [ -z "$FIREBASE_TOKEN" ]; then
            echo "FIREBASE_CI_TOKEN is empty! Using dummy firebase options for build."
            dart run scripts/generate_dummy_firebase_options.dart
          else
            flutterfire configure --project=parable-bloom --out=lib/firebase_options.dart --platforms=web --yes --token="$FIREBASE_TOKEN"
          fi

      - name: Build All
        run: task build:all

  level-data-validate:
    name: Level data validation (Task)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v6
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25'
      - name: Set up Task
        uses: arduino/setup-task@v2
      - name: Validate levels (Task)
        run: |
          task levels:validate
          task levels:tutorials:validate
